<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infografía del Calendario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 1200px;
        }
        .header-title {
            color: #1a73e8;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh; /* Ajusta la altura máxima para que se active el scroll */
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
         .table th {
            position: sticky; /* Hacemos el encabezado fijo */
            top: 0;
            background-color: #e5e7eb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            text-align: center;
            padding: 0.75rem;
            z-index: 10;
        }
        .table td {
            padding: 0.75rem;
            text-align: left;
            padding: 0.2rem; /* Ajuste para un espaciado más pequeño */
            border-bottom: 2px solid #e5e7eb;
        }
        .table tr:last-child td {
            border-bottom: none;
        }
        .btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1765cc;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .loading-text, .error-text {
            text-align: center;
            font-size: 1.25rem;
            margin-top: 2rem;
        }
        .hidden {
            display: none;
        }
/* Formatos de TOOLTIP */
        .tooltip-container {
    position: relative; /* Es necesario para posicionar el tooltip dentro de él */
    display: inline-block; /* Para que el contenedor se ajuste al tamaño del botón */
}

.tooltip-text {
    visibility: hidden; /* Oculto por defecto */
    width: 160px; /* Ancho del tooltip */
    background-color: #333; /* Fondo oscuro */
    color: #fff; /* Texto blanco */
    text-align: center;
    border-radius: 6px;
    padding: 8px 0;
    position: absolute; /* Posicionamiento absoluto respecto al .tooltip-container */
    z-index: 10; /* Asegura que esté por encima de otros elementos */
    bottom: 125%; /* Posiciona el tooltip arriba del botón */
    left: 50%;
    margin-left: -80px; /* Centra el tooltip */
    opacity: 0;
    transition: opacity 0.3s, visibility 0.3s; /* Transición suave */
    font-size: 0.875rem; /* Tamaño de fuente más pequeño */
}

/* Flecha del tooltip */
.tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%; /* En la parte inferior del tooltip */
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent; /* Color de la flecha */
}

/* Mostrar el tooltip cuando el mouse está sobre el contenedor */
.tooltip-container:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}
    </style>
</head>
<body>

<div class="container">
    <div class="header-title">Plan de trabajo detallado (Hito 1)</div>
     <p class="text-gray-700 my-3" style="text-align:left">
     Incluye cronograma (actividades y temporalidad), responsables y fases metodológicas, para la realización del diagnóstico de oportunidades de mercado, planes de negocios y mapeo de habilidades.
      </p>
    <div class="loading-text" id="loading">Cargando datos...</div>
    <div class="error-text hidden" id="error">
        Hubo un error al cargar los datos. Por favor, asegúrate de que el enlace de la hoja de cálculo sea correcto y de que el archivo es público.
    </div>
    <!-- AGREGADO: Controles para filtros y búsqueda -->
    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
        <select id="category-filter" class="w-full md:w-auto p-2.5 rounded-lg border border-gray-300 bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
            <option value="all">Todas las Categorías</option>
            <option value="Comunidad">Comunidad</option>
            <option value="ASR">ASR</option>
            <option value="Reunión">Reunión</option>
            <option value="FUSAL">Fusal</option>
            <option value="Hito">Hito</option>
            <option value="Fase">Fase</option>
        </select>
        <input type="text" id="search-bar" placeholder="Buscar..." class="w-full md:w-auto p-2.5 rounded-lg border border-gray-300 bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
    </div>
    <!-- FIN AGREGADO -->

    <div class="table-container hidden" id="data-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Descripción de Actividades e Hitos</th>
                    <!-- Se ha ocultado la columna FASES -->
                    <th>Categoría</th>
                    <th>Responsable*</th>
                    <th class="text-center">Progreso</th>
                    <th class="text-center">Inicio</th>
                    <th class="text-center">Fin</th>
                    <th class="text-center">Días</th>
                </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>
    </div>

     <div class="btn-group flex justify-center items-center space-x-4">
     <div class="tooltip-container">  
     <button class="btn btn-primary" onclick="window.location.href='index.html'">Volver a Infografía Principal</button>
     <span class="tooltip-text">Regresar a página principal</span>
     </div>
    <div class="tooltip-container">   
    <a href="https://drive.google.com/file/d/1exK7Wu9RomN4LZj0hkyI5V8718VjUFlA/view?usp=sharing" target="_blank" class="btn btn-primary">Ver fases metodológicas</a>
    <span class="tooltip-text">Ver la Metodología completa en PDF.</span>
    </div>
   </div>
    
    <div>
      <p class="text-gray-700 pt-3" style="text-align:left">
        * Responsables: LG - Luís González; CC - Claudia Cruz; DM - Danilo Martínez; MA - Marcos Andrade;  OA - Oscar Artiga; SP - Susana Panameño; KS - Karla Segovia;<br>
          OS - Oscar Sánchez; EL - Evelyn De León; HR - Héctor Ramos.
      </p>
    </div>

</div>

<script>
    const SPREADSHEET_ID = '1G3yqAu5oMCxuc1HtreBRDiMDyXNcvaIo'; 
    const SHEET_NAME = 'Calendario'; 
    const RANGE = 'A:H'; 
    
    const loadingEl = document.getElementById('loading');
    const categoryFilter = document.getElementById('category-filter');
    const searchBar = document.getElementById('search-bar');
    const errorEl = document.getElementById('error');
    const dataContainerEl = document.getElementById('data-container');
    const tableBody = document.getElementById('table-body');

    // Función para obtener los datos de Google Sheets
    async function fetchSheetData() {
        try {
            loadingEl.classList.remove('hidden');
            dataContainerEl.classList.add('hidden');
            errorEl.classList.add('hidden');

            const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=${RANGE}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Error en la red o en el enlace de la hoja de cálculo.');
            }
            const text = await response.text();

            const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
            const data = JSON.parse(jsonText);
            
            return data.table.rows;

        } catch (error) {
            console.error('Fetch error:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            return [];
        }
    }
    
    // Función para limpiar y extraer los valores de las celdas
    function cleanData(rows) {
        if (!rows || rows.length === 0) {
            return [];
        }
        return rows.map(row => {
            return row.c.map(cell => {
                // Utiliza 'f' para valores formateados si están disponibles, si no 'v'
                if (cell && cell.f !== undefined) {
                    return cell.f;
                }
                if (cell && cell.v !== undefined) {
                    return cell.v;
                }
                return '';
            });
        });
    }

    // Función para renderizar la tabla con los datos
    function renderTable(rows) {
        tableBody.innerHTML = '';
        
        const dataRows = cleanData(rows);
        
        if (dataRows.length > 0) {
            // Omitir la primera fila (encabezados) del Google Sheet
            const contentRows = dataRows.slice(1);

            contentRows.forEach(row => {
                const tr = document.createElement('tr');
            // Aplicar estilos según la categoría (índice 2)
                const categoria = row[2];
            // AGREGADO: Asignar un atributo de dato para el filtro
                tr.dataset.category = categoria;
           // FIN AGREGADO
                
                // Aplicar estilos según la categoría
                if (categoria === 'FUSAL') {
                    tr.classList.add('text-blue-900', 'font-bold');
                } else if (categoria === 'Comunidad') {
                    tr.classList.add('text-green-600');
                } else if (categoria === 'Fase') { // Nueva condición para Fases
                    tr.classList.add('font-bold', 'bg-gray-100');
                }

                // Renderizar las celdas, omitiendo la columna FASES (índice 1)
                // y aplicando los formatos y estilos solicitados
                row.forEach((cellValue, cellIndex) => {
                    if (cellIndex === 1) return; // Omitir la columna FASES

                    const td = document.createElement('td');
                    td.textContent = cellValue;
                    
                    // Aplicar formato de porcentaje y centrar la columna Progreso (índice 4)
                    if (cellIndex === 4 && typeof cellValue === 'number') {
                        td.textContent = `${Math.round(cellValue * 100)}%`;
                        td.classList.add('text-center');
                    }
                    
                    // Formatear las columnas de fecha (índices 5 y 6)
                    if (cellIndex === 5 || cellIndex === 6) {
                        const dateMatch = String(cellValue).match(/Date\((\d+),(\d+),(\d+)\)/);
                        if (dateMatch) {
                            const year = parseInt(dateMatch[1]);
                            const month = parseInt(dateMatch[2]);
                            const day = parseInt(dateMatch[3]);
                            const date = new Date(year, month, day);
                            td.textContent = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        }
                        td.classList.add('text-center');
                    }

                    // Centrar la columna Días (índice 7)
                    if (cellIndex === 7) {
                        td.classList.add('text-center');
                    }

                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            loadingEl.classList.add('hidden');
            dataContainerEl.classList.remove('hidden');
        } else {
            loadingEl.classList.add('hidden');
            errorEl.textContent = 'No se encontraron datos en la hoja de cálculo.';
            errorEl.classList.remove('hidden');
        }
    }

        // AGREGADO: Función para filtrar y buscar en la tabla
    function filterAndSearchTable() {
        const selectedCategory = categoryFilter.value;
        const searchTerm = searchBar.value.toLowerCase();
        
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            const rowCategory = row.dataset.category;
            
            // Condición para mostrar la fila: debe coincidir con el filtro de categoría Y la búsqueda
            const categoryMatches = selectedCategory === 'all' || rowCategory === selectedCategory;
            const searchMatches = rowText.includes(searchTerm);

            if (categoryMatches && searchMatches) {
                row.style.display = ''; // Muestra la fila
            } else {
                row.style.display = 'none'; // Oculta la fila
            }
        });
    }

    // AGREGADO: Eventos para escuchar los cambios en los filtros y la barra de búsqueda
    categoryFilter.addEventListener('change', filterAndSearchTable);
    searchBar.addEventListener('input', filterAndSearchTable);
    // FIN AGREGADO
    
    async function init() {
        const rows = await fetchSheetData();
        renderTable(rows);
    }

    window.onload = init;
</script>

</body>
</html>
