<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Comentarios</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Comentarios</h1>
        <p class="text-gray-500 mt-1">Para nosotros es importante tu opinión.</p>
    </div>

    <!-- Sección de mensajes de estado -->
    <div id="statusMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
        <span class="font-medium"></span>
    </div>

    <!-- Formulario de comentarios -->
    <form id="commentForm" class="space-y-4">
        <div>
            <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
            <input type="text" id="nombre" name="nombre" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
        </div>
        <div>
            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="email" name="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
        </div>
        <div>
            <label for="tema" class="block text-sm font-medium text-gray-700">Tema</label>
            <select id="tema" name="tema" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                <option value="">Selecciona un tema</option>
                <option value="Soporte Técnico">Soporte Técnico</option>
                <option value="Sugerencia de producto">Sugerencia de producto</option>
                <option value="Reportar un problema">Reportar un problema</option>
                <option value="Otros">Otros</option>
            </select>
        </div>
        <div>
            <label for="comentario" class="block text-sm font-medium text-gray-700">Comentario (máximo 500 caracteres)</label>
            <textarea id="comentario" name="comentario" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" maxlength="500" required></textarea>
        </div>
        <div>
            <button type="submit" id="submitButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Enviar Comentario
            </button>
        </div>
    </form>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Habilitar logging de Firebase para debugging
    setLogLevel('Debug');

    // Variables globales inyectadas por la plataforma
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const statusMessageElement = document.getElementById('statusMessage');
    const commentForm = document.getElementById('commentForm');
    const submitButton = document.getElementById('submitButton');

    let app;
    let auth;
    let db;
    let userId;

    function showStatusMessage(message, type = 'error') {
        statusMessageElement.textContent = message;
        statusMessageElement.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
        if (type === 'error') {
            statusMessageElement.classList.add('bg-red-100', 'text-red-800');
        } else {
            statusMessageElement.classList.add('bg-green-100', 'text-green-800');
        }
        statusMessageElement.classList.remove('hidden');
    }

    async function initializeFirebase() {
        try {
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                showStatusMessage('Error de configuración: firebaseConfig está vacío o no es válido. Revisa el backend.');
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Intentar iniciar sesión con el token de la plataforma
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // Si no hay token, iniciar sesión de forma anónima
                await signInAnonymously(auth);
            }
            userId = auth.currentUser.uid;
            console.log("Usuario autenticado con ID:", userId);
            showStatusMessage('Conectado a la base de datos de forma exitosa.', 'success');

        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            showStatusMessage(`Error al conectar con la base de datos. Revisa la consola para más detalles. Error: ${error.message}`);
        }
    }

    commentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitButton.disabled = true;
        const nombre = document.getElementById('nombre').value;
        const email = document.getElementById('email').value;
        const tema = document.getElementById('tema').value;
        const comentario = document.getElementById('comentario').value;

        if (!db) {
            showStatusMessage('Error: No se ha podido conectar a la base de datos.');
            submitButton.disabled = false;
            return;
        }

        try {
            await addDoc(collection(db, `/artifacts/${appId}/public/data/miscomentarios`), {
                nombre,
                email,
                tema,
                comentario,
                timestamp: serverTimestamp(),
                userId: userId // Guardar el ID de usuario para referencia
            });
            showStatusMessage('¡Comentario enviado con éxito!', 'success');
            commentForm.reset(); // Limpiar el formulario
        } catch (error) {
            console.error("Error al enviar el comentario:", error);
            showStatusMessage(`Hubo un error al enviar tu comentario. Por favor, revisa la consola. Error: ${error.message}`);
        } finally {
            submitButton.disabled = false;
        }
    });

    window.onload = async () => {
        await initializeFirebase();
    };
</script>

</body>
</html>
