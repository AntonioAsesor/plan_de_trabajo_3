<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario de la Consultor√≠a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem;
      box-sizing: border-box;
    }
    .container {
      background-color: white;
      border-radius: 1.5rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      width: 100%;
      max-width: 1200px;
      box-sizing: border-box;
    }
    /* üîπ Grid estable para 7 columnas exactas */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
    }
    .day-name {
      text-align: center;
      padding: 0.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      background-color: #e5e7eb;
      color: #4b5563;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .day {
      background-color: #f9fafb;
      color: #1f2937;
      position: relative;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      cursor: pointer;
      padding: 0.25rem;
      box-sizing: border-box;
      overflow: hidden; /* üîπ evita que el contenido se desborde */
      word-wrap: break-word;
    }
    .day-number {
      font-size: 0.875rem;
      color: #6b7280;
      text-align: right;
      width: 100%;
      flex-shrink: 0;
    }
    .events-container {
      flex-grow: 1;
      overflow-y: auto;
      max-height: 90px;
      margin-top: 0.25rem;
    }
    .event {
      width: 100%;
      margin: 2px 0;
      border-radius: 0.25rem;
      padding: 2px 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: white;
      font-weight: 500;
      cursor: pointer;
    }
    .event-Fase { background-color: #4a90e2; }
    .event-Hito { background-color: #2dff8c; }
    .event-Comunidad { background-color: #2ecc71; }
    .event-FUSAL { background-color: #0000ff; }
    .event-ASR { background-color: #f79646; }
    .event-Reuni√≥n { background-color: #c0504d; }

     .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
    .btn-primary:hover {
            background-color: #1765cc;
        }
        .loading-text, .error-text {
            text-align: center;
            font-size: 1.25rem;
            margin-top: 2rem;
        }
        .hidden {
            display: none;
        }
    .calendar-footer {
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
        }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      width: 100%;
      max-width: 500px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-xl font-bold text-blue-600 mb-4">Calendario de la Consultor√≠a</h1>
    <p class="text-gray-700 my-3" style="text-align:left">
        Visualizaci√≥n de los hitos y actividades clave de la consultor√≠a en un formato de calendario.
    </p>
    <div id="calendar-container">
        <div class="header">
          <button id="prev-month" class="btn btn-primary">&lt;</button>
          <div class="month-year" id="month-year-display"></div>
          <button id="next-month" class="btn btn-primary">&gt;</button>
        </div>
      <div class="calendar-grid" id="calendar-grid">
        <div class="day-name">Lun</div>
        <div class="day-name">Mar</div>
        <div class="day-name">Mi√©</div>
        <div class="day-name">Jue</div>
        <div class="day-name">Vie</div>
        <div class="day-name">S√°b</div>
        <div class="day-name">Dom</div>
      </div>
    </div>
    <div class="btn-group flex justify-center items-center space-x-4">
      <button class="btn btn-primary" onclick="window.location.href='index.html'">Volver a Infograf√≠a Principal</button>
    </div>
    <div class="calendar-footer">
      *Los colores indican la categor√≠a de la actividad.
    </div>
  </div>
  
  <!-- Modal -->
  <div id="event-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title" class="text-lg font-bold mb-2">Detalle del evento</h2>
      <div id="modal-body" class="space-y-1 text-sm"></div>
      <div class="text-right mt-3">
        <button id="close-modal" class="px-4 py-2 bg-blue-600 text-white rounded">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = "1G3yqAu5oMCxuc1HtreBRDiMDyXNcvaIo";
    const SHEET_NAME = "Calendario";
    const RANGE = "A:H";

    const calendarGrid = document.getElementById("calendar-grid");
    const modal = document.getElementById("event-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalBody = document.getElementById("modal-body");
    const closeModal = document.getElementById("close-modal");

        const monthYearDisplay = document.getElementById('month-year-display');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const tooltipEl = document.getElementById('event-tooltip');

    let allEvents = [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function parseDate(val) {
      if (!val) return null;
      const d = new Date(val);
      return isNaN(d) ? null : d;
    }

    async function fetchSheetData() {
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}&range=${RANGE}`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));

      const events = json.table.rows.slice(1).map(r => {
        const c = r.c.map(cell => cell ? (cell.f || cell.v) : null);
        return {
          description: c[0],
          category: c[2],
          responsable: c[3],
          progreso: c[4],
          startDate: parseDate(c[5]),
          endDate: parseDate(c[6]),
          dias: c[7]
        };
      }).filter(e => e.startDate && e.endDate);

      allEvents = events;
      return events;
    }

    function renderCalendar(month, year) {
      const oldDays = calendarGrid.querySelectorAll(".day");
      oldDays.forEach(el => el.remove());

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      let start = firstDay === 0 ? 6 : firstDay - 1;

      for (let i = 0; i < start; i++) {
        const empty = document.createElement("div");
        empty.classList.add("day");
        calendarGrid.appendChild(empty);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const dayEl = document.createElement("div");
        dayEl.classList.add("day");

        const num = document.createElement("div");
        num.classList.add("day-number");
        num.textContent = d;
        dayEl.appendChild(num);

        const eventsC = document.createElement("div");
        eventsC.classList.add("events-container");

        const current = new Date(year, month, d);

        allEvents.forEach(ev => {
          if (current >= ev.startDate && current <= ev.endDate) {
            const evEl = document.createElement("div");
            evEl.classList.add("event", `event-${ev.category?.replace(/\s/g,"")}`);
            evEl.textContent = ev.description;

            evEl.addEventListener("click", () => {
              modalTitle.textContent = ev.description;
              modalBody.innerHTML = `
                <p><strong>Responsable:</strong> ${ev.responsable || "-"}</p>
                <p><strong>Progreso:</strong> ${ev.progreso || "-"}</p>
                <p><strong>Inicio:</strong> ${ev.startDate.toLocaleDateString()}</p>
                <p><strong>Fin:</strong> ${ev.endDate.toLocaleDateString()}</p>
                <p><strong>D√≠as:</strong> ${ev.dias || "-"}</p>
              `;
              modal.style.display = "flex";
            });

            eventsC.appendChild(evEl);
          }
        });

        dayEl.appendChild(eventsC);
        calendarGrid.appendChild(dayEl);
      }
    }

    closeModal.addEventListener("click", () => modal.style.display = "none");
    window.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });

    async function init() {
      allEvents = await fetchSheetData();
      renderCalendar(currentMonth, currentYear);
    }

    init();
  </script>
</body>
</html>
