<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plan de Trabajo: DiagnÃ³stico en Villas Concordia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .event {
      background-color: #3b82f6;
      color: white;
      padding: 2px 4px;
      border-radius: 4px;
      margin-top: 2px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .event:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body class="bg-gray-50 p-6">

  <h1 class="text-2xl font-bold text-blue-700 mb-4">ðŸ“… Plan de Trabajo: DiagnÃ³stico en Villas Concordia</h1>
  <div id="calendar" class="grid grid-cols-7 gap-2"></div>

  <!-- ==================== MODAL DETALLE EVENTO ==================== -->
  <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
      <h2 id="modal-title" class="text-xl font-bold text-blue-600 mb-4">Detalle del Evento</h2>
      <div id="modal-content" class="space-y-2 text-sm text-gray-700"></div>
      <div class="mt-4 text-right">
        <button id="close-modal" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    const sheetId = "TU_SHEET_ID"; // ðŸ‘‰ reemplaza con tu ID de Google Sheet
    const sheetName = "Gantt";

    // ==================== FUNCIÃ“N: Parsear fecha ====================
    function parseDate(value) {
      if (!value) return null;
      const date = new Date(value);
      return isNaN(date) ? null : date;
    }

    // ==================== FUNCIÃ“N: Leer datos de Google Sheets ====================
    async function fetchSheetData() {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0, -2));

      const events = json.table.rows.slice(1).map(row => {
        const parts = row.c.map(cell => (cell && cell.v !== undefined) ? (cell.f || cell.v) : null);

        const description = parts[0];          // Col A
        const category = parts[2];             // Col C
        const responsable = parts[3];          // Col D
        const progreso = parts[4];             // Col E
        const startDate = parseDate(parts[5]); // Col F
        const endDate = parseDate(parts[6]);   // Col G
        const dias = parts[7];                 // Col H

        return { description, category, responsable, progreso, startDate, endDate, dias };
      }).filter(event => event.startDate && event.endDate);

      return events;
    }

    // ==================== FUNCIÃ“N: Renderizar calendario ====================
    function renderCalendar(events) {
      const calendarEl = document.getElementById("calendar");
      calendarEl.innerHTML = "";

      // Encabezados de los dÃ­as
      const days = ["Dom", "Lun", "Mar", "MiÃ©", "Jue", "Vie", "SÃ¡b"];
      days.forEach(day => {
        const dayEl = document.createElement("div");
        dayEl.classList.add("font-bold", "text-center", "p-2", "bg-gray-200");
        dayEl.textContent = day;
        calendarEl.appendChild(dayEl);
      });

      // Determinar mes actual
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      // Celdas vacÃ­as antes del 1
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement("div");
        calendarEl.appendChild(emptyCell);
      }

      // DÃ­as del mes
      for (let date = 1; date <= lastDate; date++) {
        const dayCell = document.createElement("div");
        dayCell.classList.add("border", "h-24", "p-1", "relative");

        const dateEl = document.createElement("div");
        dateEl.classList.add("text-xs", "text-gray-500");
        dateEl.textContent = date;
        dayCell.appendChild(dateEl);

        const eventsContainer = document.createElement("div");
        eventsContainer.classList.add("space-y-1");

        const currentDate = new Date(year, month, date);
        events.forEach(event => {
          if (currentDate >= event.startDate && currentDate <= event.endDate) {
            const eventEl = document.createElement("div");
            eventEl.classList.add("event", `event-${event.category?.replace(/\s/g, '') || 'General'}`);
            eventEl.textContent = event.description;

            // ðŸ‘‰ Nuevo: al hacer click, abrir modal con detalle
            eventEl.addEventListener("click", () => showEventModal(event));

            eventsContainer.appendChild(eventEl);
          }
        });

        dayCell.appendChild(eventsContainer);
        calendarEl.appendChild(dayCell);
      }
    }

    // ==================== FUNCIÃ“N: Mostrar modal ====================
    function showEventModal(event) {
      const modal = document.getElementById("event-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalContent = document.getElementById("modal-content");

      modalTitle.textContent = event.description;
      modalContent.innerHTML = `
        <p><strong>Responsable:</strong> ${event.responsable || "â€”"}</p>
        <p><strong>Progreso:</strong> ${event.progreso || "â€”"}</p>
        <p><strong>Inicio:</strong> ${event.startDate.toLocaleDateString()}</p>
        <p><strong>Fin:</strong> ${event.endDate.toLocaleDateString()}</p>
        <p><strong>DÃ­as:</strong> ${event.dias || "â€”"}</p>
      `;

      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    // ==================== EVENTO: Cerrar modal ====================
    document.getElementById("close-modal").addEventListener("click", () => {
      const modal = document.getElementById("event-modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    // ==================== INICIALIZACIÃ“N ====================
    fetchSheetData().then(events => renderCalendar(events));
  </script>
</body>
</html>
